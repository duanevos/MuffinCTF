@inject IUserService UserService
@inject NavigationManager NavigationManager
@inject ICookie cookie
@inject CCService CCService
@inject IChallengeService ChallengeService
@using MuffinCTF.Components.Challenges
@page "/challenges"

@if (loading)
{
    <Loading />
}
else
{
    <CascadingValue Value="this">
    @if(!completedFirstChallenge){
        <FirstChallenge />
    } else {
        @if(showIcons){
            <Icons />
        } else {
            <ChallengeCard />
        }
    }
    </CascadingValue>
}

@code {
    //Used for conditional rendering
    private bool loading = true;
    private bool completedFirstChallenge = false;
    public string showCategory = "";
    public bool showIcons = true;

    //Logged in User
    private User? User { get; set; } = null;
    
    //Challenges To Complete
    private List<Challenge> challenges { get; set; } = new List<Challenge>();

    //Has to be OnAfterRenderAsync
    //JavaScript interop calls can only be performed during the OnAfterRenderAsync lifecycle method.
    //Using JSInterop call for cookies.
    protected async override Task OnAfterRenderAsync(bool firstRender)
    {
        if(firstRender){
            var tokenCookie = await cookie.GetValue("token");
            var usernameCookie = await cookie.GetValue("user");
            var user = await UserService.ValidateToken(tokenCookie, usernameCookie);
            if (tokenCookie != string.Empty && usernameCookie != string.Empty && user is not null)
            {
                completedFirstChallenge = await CCService.CheckIfCompleted(1, user!.Id);
                loading = false;
                User = user;
                StateHasChanged();
            }
            else
            {
                NavigationManager.NavigateTo("/login");
            }
        }
    }

    public async void OnFlagCorrectSubmit(Challenge challenge)
    {
        await CCService.AddCompletedChallenge(challenge.Id, User!.Id);
        await UserService.UpdateUserScore(User);
        completedFirstChallenge = true;
        StateHasChanged();
    }

    public void OnDblClick(string category)
    {
        showCategory = category;
        showIcons = !showIcons;
        StateHasChanged();
    }
    
    public void OnCloseClick()
    {
        showCategory = "";
        showIcons = !showIcons;
        StateHasChanged();
    }
}
